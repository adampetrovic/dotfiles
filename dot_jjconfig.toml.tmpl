[user]
name = "{{ .full_name }}"
email = "{{ .email }}"

[signing]
behaviour = "own"
backend = "ssh"
backends.ssh.program = "/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
backends.ssh.allowed-signers = "~/.config/git/allowed_ssh_signers"

[ui]
editor = "vim"
default-command = "log"
diff-formatter = ["delta", "--dark", "$left", "$right"]

[fix.tools.detekt]
command = ["./gradlew", "detekt"]
patterns = ["glob:'**/*.kt'"]

[git]
auto-local-bookmark = false
push-bookmark-prefix = "apetrovic/push-"
push-new-bookmarks = true

[revsets]
log = "ancestors(immutable_heads()..(immutable_heads() | bookmarks() | @), 2)"

[revset-aliases]
"mine()" = "author(exact:'{{ .full_name }}') | author(exact:'{{ .email }}')"
"immutable_heads()" = "trunk() | tags()"
"stack()" = "ancestors(mutable() & (..@ | @::), 2)"
"streams()" = "heads(::@ & bookmarks())"
"change()" = "::@ ~ ::main@origin"
"branch_point()" = "roots(::@ ~ ::main@origin)-"
"remote_head()" = "remote_bookmarks() & ancestors(@) & heads(remote_bookmarks())"
"local_changes()" = "@ ~ remote_head()"

'why_immutable(r)' = '(r & immutable()) | roots(r:: & immutable_heads())'

[aliases]
sync = ['git', 'fetch', '--all-remotes']
restack = ['rebase', '--skip-emptied', '-d', 'trunk()']
merge-main = ['new', '-r', 'trunk()', '@', '-m', 'merge main']
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]
start = ['new', '-r', 'trunk()', '-m']
forget = ['bookmark', 'forget']

track = [
  "util",
  "exec",
  "--",
  "bash",
  "-c",
  '''
  #!/usr/bin/env bash
  set -eu -o pipefail

  # Sync remotes first
  jj git fetch --all-remotes

  # Track the remote bookmark
  jj bookmark track "$1@origin"

  # Create new changeset on top of the tracked bookmark
  jj new -r "$1"
  ''',
  "",
]

local-diff = [
  "util",
  "exec", 
  "--",
  "bash",
  "-c",
  '''
  #!/usr/bin/env bash
  set -eu -o pipefail
  
  # Get the current bookmark name using jj from same working directory
  bookmark=$(jj log --no-graph -r @ -T 'local_bookmarks.map(|b| b.name()).join(" ")' | tr -d ' ')
  
  if [[ -z "$bookmark" ]]; then
    echo "No local bookmark found at current commit"
    exit 1
  fi
  
  # Diff against the remote version
  jj diff --from "${bookmark}@origin" --to @
  ''',
  "",
]

dv = [
  "--config=templates.draft_commit_description=commit_description_verbose(self)",
  "describe",
]

streams = [
  "log",
  "--no-graph",
  "-r",
  "streams()",
  "-T",
  "bookmarks.map(|b| b ++ ' ')",
]

rdiff = [
  "util",
  "exec",
  "--",
  "bash",
  "-c",
  '''
  #!/usr/bin/env bash
  set -eu -o pipefail

  target=$1

  # todo: configurable stream head
  bookmark_names=$(jj log --no-graph -r 'heads(::@ & bookmarks())' -T 'local_bookmarks.map(|l| l.name() ++ " ")')
  IFS=" " read -ra bookmarks <<<"$bookmark_names"
  # todo: error message
  [ ${#bookmarks[@]} -eq 1 ] || exit 1
  bookmark=${bookmarks[0]}

  all_refs=$(jj evolog --no-graph -T 'commit_id ++ "|"' -r "$target")
  remote=$(jj log --no-graph -T 'commit_id' -n 1 -r "($all_refs none()) & ::$bookmark@origin")

  jj diff --from "$remote" --to "$target"
  ''',
  "",
]

[template-aliases]
"link(target, text)" = 'raw_escape_sequence("\x1b]8;;" ++ target ++ "\x1b\\") ++ label("text link", text) ++ raw_escape_sequence("\x1b]8;;\x1b\\")'

"commit_description_verbose(commit)" = '''
concat(
  commit_description(commit),
  "JJ: ignore-rest\n",
  diff.git(),
)
'''

"commit_description(commit)" = '''
concat(
  commit.description(), "\n",
  "JJ: This commit contains the following changes:\n",
  indent("JJ:    ", diff.stat(72)),
)
'''

[templates]
draft_commit_description = "commit_description(self)"
